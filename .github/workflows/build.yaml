name: Build and Release

on: push

jobs:
  build:
    name: Build Switcher
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Xcode
        uses: apple-actions/setup-xcode@v1
        with:
          xcode-version: 'latest'

      - name: Build Xcode project 
        uses: sersoft-gmbh/xcodebuild-action@v3
        with:
          project: Switcher.xcodeproj
          scheme: Switcher
          destination: platform=macOS
          configuration: Release
          action: build

      - name: Build Xcode project
        run: |
          xcodebuild -project Switcher.xcodeproj -configuration Release -arch x86_64 -arch arm64 -sdk macosx build

      - name: Archive Build Artifacts
        run: zip -r Switcher-${{ github.ref_name == contains(github.ref, 'refs/tags/v') && github.ref_name || github.run_number }}.zip build/Release

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v3
        with:
          name: Switcher-Build
          path: Switcher-${{ github.ref_name == contains(github.ref, 'refs/tags/v') && github.ref_name || github.run_number }}.zip

  release:
    name: Release Switcher
    runs-on: macos-latest
    needs: build
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Download Build Artifacts
        uses: actions/download-artifact@v3
        with:
          name: Switcher-Build

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: Switcher-${{ github.ref_name }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
